<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map</title>
    <!-- Inclua o Leaflet via CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin=""></script>
    <!-- Inclua a biblioteca de autocompletar do Leaflet -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" crossorigin=""></script>
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <!-- Estilos CSS opcionais para personalização -->
    <style>
        #map { height: 400px; }
    </style>
</head>
<body>
    <!-- Elemento div para exibir o mapa -->
    <div id="map"></div>
    <div>
        <!-- Campo para inserir o endereço de destino -->
        <input type="text" id="endereco-destino" placeholder="Insira o endereço de destino">
        <!-- Botão para adicionar destino -->
        <button onclick="adicionarDestino()">Adicionar Destino</button>
    </div>

    <script>
        var map = L.map('map').setView([-23.55052, -46.633308], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var partidaMarker;
        var destinoMarker;

        function adicionarPontoDePartida(pos) {
            partidaMarker = L.marker(pos).addTo(map).bindPopup('Ponto de Partida').openPopup();
            map.setView(pos, 13);
        }

        function adicionarDestino() {
            var enderecoDestino = document.getElementById('endereco-destino').value;
            if (enderecoDestino) {
                // Use o serviço de geocodificação do OpenStreetMap para obter as coordenadas do endereço inserido
                fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + enderecoDestino)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            var latlng = [data[0].lat, data[0].lon];
                            if (destinoMarker) {
                                map.removeLayer(destinoMarker);
                            }
                            destinoMarker = L.marker(latlng).addTo(map).bindPopup('Destino').openPopup();
                            if (partidaMarker) {
                                calcularRota(partidaMarker.getLatLng(), latlng);
                            }
                        } else {
                            alert("Endereço não encontrado. Por favor, insira um endereço válido.");
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter coordenadas do endereço:', error);
                        alert("Erro ao obter coordenadas do endereço. Por favor, tente novamente mais tarde.");
                    });
            } else {
                alert("Por favor, insira um endereço de destino.");
            }
        }

        function calcularRota(origem, destino) {
            L.Routing.control({
                waypoints: [
                    L.latLng(origem),
                    L.latLng(destino)
                ]
            }).addTo(map);
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                adicionarPontoDePartida(pos);
            }, function() {
                console.log('Não foi possível obter a localização do usuário.');
            });
        } else {
            console.log('Geolocalização não é suportada pelo seu navegador.');
        }
    </script>
</body>
</html>
